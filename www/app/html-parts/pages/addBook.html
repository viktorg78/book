<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Книга [Добавить книгу]</title>
    <link rel="stylesheet" href="css/main.min.css">
    <script src="js/close-modal-entry.js" defer></script>
</head>
<body>
<div class="page">
    @@include('../header.html')
    <main class="main">
        <!-- Модальное окно ошибок -->
        <div class="css-modal-target" id="modal-error">
            <div class="cmt" id="windowBody">
                <a href="#close" class="css-modal-close" id="close-modal-error" title="Закрыть">&times;</a>
                <div class="heading-error">
                    ОШИБКА
                </div>
                <div id="textError"></div>

            </div>
        </div>
        <!-- Конец Модальное окна -->

        <!-- Модальное окно циклов -->
        <div class="css-modal-target" id="modal-loop">
            <div class="cmt">
                <a href="#close" class="css-modal-close" id="close-modal-loop" title="Закрыть">&times;</a>
                <form id="formLoop">
                    <div class="formEmpty">
                        <h3>СОЗДАТЬ НОВЫЙ ЦИКЛ</h3>
                        <input type="text" id="nameLoopInput" placeholder="Название цикла">
                        <button type="submit">создать</button>
                    </div>
                </form>
                <div id="text-loop"></div>

            </div>
        </div>
        <!-- Конец Модальное окна -->

        <!-- Модальное окно добавление главы -->
        <div class="css-modal-target" id="modal-add-chapter">
            <div class="cmt">
                <a href="#close" class="css-modal-close" id="close-modal-add-chapter" title="Закрыть">&times;</a>
                <form id="formAddChapter">
                    <div class="formEmpty">
                        <h3>СОЗДАТЬ ГЛАВУ</h3>
                        <input type="text" id="nameAddChapterInput" placeholder="Название главы">
                        <button type="submit">Создать</button>
                    </div>
                </form>
                <div id="text-add-chapter"></div>

            </div>
        </div>
        <!-- Конец Модальное окна -->


        <div class="tab">
<!--            вкладка 1-->
            <div class="tab-content" id="content-1">
                <div class="add-book">
                    <form id="formNewBook">
                        <div class="cart-book">
                            <div class="add-img">
                                <a id="openModal" href="#modal-error">модал</a>
                                <div class="preview">
                                    <b>Обложка книги</b><br>
                                    Размер изображения должен быть не менее 200 пикселей в ширину и 285 в высоту.<br>
                                    Максимальный размер файла: 5 мб.
                                </div>
                                <label for="riss">
                                    <div class="block-img">
                                        <img id="e4r45t" src="">
                                        <input id="riss" type="file" accept="image/png, image/jpeg"/>
                                    </div>
                                </label>
                                <label for="riss" class="pseudo-button">загрузить обложку</label>
                            </div>

                            <div class="block-input">
                                <div>
                                    <label for="nameBook">Название книги:</label>
                                    <input type="text" id="nameBook">
                                </div>

                                <div>
                                    <label for="inputCategory">Жанр:</label>
                                    <select id="inputCategory">
                                        <option value="" selected disabled hidden>Выберите значение</option>
                                        <option value="1">Детектив</option>
                                        <option value="1">Фантастика</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="tegBook">
                                        Тэги для поиска через пробел. <code>Максимум 5 тегов.</code>
                                    </label><br>
                                    <label for="tegBook" id="TageCharacterCount">Введено 0 тегов.</label>
                                    <textarea id="tegBook" rows="2"></textarea>
                                </div>

                                <div>
                                    <label for="inputDescription">
                                        Краткое описание книги. Расскажите о чем она. <code>Максимум 400 символов.</code>
                                    </label><br>
                                    <label for="inputDescription" id="descriptionCharacterCount">Введено 0 символов.</label>
                                    <textarea maxlength="400" id="inputDescription" rows="5"></textarea>
                                </div>

                                <div class="loop-control">
                                    <div>
                                        <label for="inputCycle">Книга входит в цикл:</label>
                                        <select id="inputCycle">
                                            <option value="" selected disabled hidden>Выберите значение</option>
                                            <option value="1">Цикл 1</option>
                                            <option value="1">Цикл 2</option>
                                            <option value="1">Цикл 3</option>
                                        </select>
                                    </div>
                                    <a href="#modal-loop">Создать цикл</a>
                                </div>
                                <div>
                                    <button type="reset" onclick="res()">Очистить</button>
                                    <button type="submit">Сохранить</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

<!--            Вкладка 2-->
            <div class="tab-content" id="content-2">
<!--                Данная вкладка должна быть доступной только после добавления книги. -->
                <div class="add-chapter">
                    <div class="add-chapter1">
                        <button onclick="window.location.href='#modal-add-chapter'">Добавить главу</button>
                        <div class="switch-with-signature">
                            <div>Редактировать порядок сортировки</div>
                            <div class="form_toggle">
                                <fieldset class="toggle_group">
                                    <div class="form_toggle-item item-1">
                                        <input id="fid-1" type="radio" name="toggle" value="off" checked>
                                        <label for="fid-1">ВЫКЛ.</label>
                                    </div>
                                    <div class="form_toggle-item item-2">
                                        <input id="fid-2" type="radio" name="toggle" value="on">
                                        <label for="fid-2">ВКЛ.</label>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <ol id="sortable-list" class="extraction">
                        <li draggable="false" class="chapter-book">
                            <h3>глава 1</h3>
                            <div class="status published">
                                Опубликована
                            </div>
                            <a><img src="img/edit.png" title="редактировать"></a>
                        </li>
                        <li draggable="false" class="chapter-book">
                            <h3>глава 2</h3>
                            <div class="status published">
                                Опубликована
                            </div>
                            <a><img src="img/edit.png" title="редактировать"></a>
                        </li>
                        <li draggable="false" class="chapter-book">
                            <h3>глава 3</h3>
                            <div class="status draft">
                                Черновик
                            </div>
                            <a><img src="img/edit.png" title="редактировать"></a>
                        </li>
                        </ol>
                    </div>
                    <div class="add-chapter1">
                        <form>
                        <input type="text" placeholder="Название главы">
                        <textarea rows="20" cols="100"></textarea>
                        <div>
                            <button type="submit">Сохранить</button>
                            <button type="reset">Очистить</button>
                        </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="tab-nav">
                <input checked id="tab-btn-1" name="tab-btn" type="radio" value="">
                <label for="tab-btn-1">Настройка</label>
                <input id="tab-btn-2" name="tab-btn" type="radio" value="">
                <label for="tab-btn-2">Текст</label>
            </div>
        </div>
    </main>
    @@include('../footer.html')
</div>
<script>
    const image = document.getElementById("e4r45t");
    const fileInput = document.getElementById("riss");
    const openModal = document.getElementById('openModal');
    const tegBookInput = document.getElementById('tegBook'); // Переименовано для ясности
    const TageCharacterCount = document.getElementById('TageCharacterCount');
    const inputDescription = document.getElementById('inputDescription');
    const descriptionCharacterCount = document.getElementById('descriptionCharacterCount');
    const formNewBook = document.getElementById('formNewBook');
    const nameBook = document.getElementById('nameBook');
    const inputCategory = document.getElementById('inputCategory');
    const formLoop = document.getElementById('formLoop');
    const inputCycle = document.getElementById('inputCycle');
    const nameLoopInput = document.getElementById('nameLoopInput');
    // перетаскивание глав
    const list = document.getElementById('sortable-list');
    let draggingElement = null;
    // Находим радиокнопки
    const radioButtonsToggle = document.querySelectorAll('input[name="toggle"]');
    const chapterBook = document.getElementsByClassName('chapter-book');
    // добавление главу
    const formAddChapter = document.getElementById('formAddChapter');


    formAddChapter.addEventListener('submit', e => {
        e.preventDefault(); // Предотвращаем стандартную отправку формы

        const nameInput = e.target.querySelector('input[type="text"]');
        if (!nameInput) {
            console.error('Поле ввода названия главы не найдено');
            return;
        }

        const nameAddChapter = nameInput.value.trim();

        // Валидация: проверяем, что поле не пустое
        if (nameAddChapter === '') {
            alert('Название главы не может быть пустым');
            return;
        }

        // Создаём элементы через DOM API (безопаснее, чем innerHTML)
        const newItem = document.createElement('li');
        newItem.classList.add('chapter-book');
        newItem.setAttribute('draggable', 'false');

        const heading = document.createElement('h3');
        heading.textContent = nameAddChapter; // Безопасное присвоение текста

        const statusDiv = document.createElement('div');
        statusDiv.className = 'status draft';
        statusDiv.textContent = 'Черновик';

        const editLink = document.createElement('a');
        const editImg = document.createElement('img');
        editImg.src = 'img/edit.png';
        editImg.alt = 'Редактировать';
        editImg.title = 'Редактировать';

        editLink.appendChild(editImg);

        // Собираем структуру
        newItem.appendChild(heading);
        newItem.appendChild(statusDiv);
        newItem.appendChild(editLink);

        // Добавляем элемент в список
        list.appendChild(newItem);

        // Закрываем модальное окно, если кнопка существует
        const closeButton = document.getElementById('close-modal-add-chapter');
        if (closeButton) {
            closeButton.click();
        } else {
            console.warn('Кнопка закрытия модального окна не найдена');
        }

        // Очищаем поле ввода
        nameInput.value = '';
    });


    radioButtonsToggle.forEach(radio => {
        radio.addEventListener('change', () => {
            const isDragModeEnabled = radio.value === 'on';

            // Обновляем класс контейнера
            list.classList.toggle('on', isDragModeEnabled);

            // Применяем изменения ко всем элементам глав
            Array.from(chapterBook).forEach(chapter => {
                // Устанавливаем атрибут draggable
                chapter.draggable = isDragModeEnabled;

                // Меняем курсор
                chapter.style.cursor = isDragModeEnabled ? 'move' : 'default';

                // Находим ссылку редактирования
                const editLink = chapter.querySelector('a');
                if (editLink) {
                    editLink.style.visibility = isDragModeEnabled ? 'hidden' : 'visible';
                }

                // Обновляем ARIA‑атрибуты для доступности
                chapter.setAttribute('aria-grabbed', isDragModeEnabled.toString());
                if (isDragModeEnabled) {
                    chapter.setAttribute('role', 'listitem');
                    chapter.setAttribute('aria-label', `Глава "${chapter.querySelector('h3')?.textContent || 'Без названия'}" — перетаскиваемая`);
                } else {
                    chapter.removeAttribute('aria-grabbed');
                    chapter.removeAttribute('role');
                    chapter.removeAttribute('aria-label');
                }
            });
        });
    });


    // 1. Начало перетаскивания
    list.addEventListener('dragstart', (e) => {
        draggingElement = e.target;
        e.target.classList.add('dragging');
    });

    // 2. Конец перетаскивания
    list.addEventListener('dragend', (e) => {
        e.target.classList.remove('dragging');
    });

    // 3. Логика перетаскивания (определение места)
    list.addEventListener('dragover', (e) => {
        e.preventDefault(); // Разрешаем сброс
        const afterElement = getDragAfterElement(list, e.clientY);
        if (afterElement == null) {
            list.appendChild(draggingElement);
        } else {
            // list.insertBefore = function(newNode, referenceNode) {
            //     this.insertBefore(newNode, referenceNode);
            // };
            list.insertBefore(draggingElement, afterElement);
        }
    });

    // Функция определения элемента, над которым находится курсор
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('li:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }




    // formLoop.addEventListener('submit', e => {
    //     const inputCycleArray = Array.from(inputCycle.options).map(option => option.text);
    //     const nameLoop = e.target.elements[0].value.trim().toUpperCase();
    //     const arrayLoop = inputCycleArray.map(str => str.trim().toUpperCase())
    //
    //     let text = '';
    //     if (arrayLoop.includes(nameLoop)){
    //         e.preventDefault();
    //         document.getElementById('close-modal-loop').click()
    //         text += "<div>У вас уже есть цикл с таким названием!</div>";
    //         document.getElementById('textError').innerHTML = text;
    //         nameLoopInput.value = '';
    //         openModal.click();
    //     }else {
    //         inputCycle.add(new Option(nameLoopInput.value.trim(), 'new_value'));
    //         document.getElementById('close-modal-loop').click()
    //     }
    //
    // });

    formLoop.addEventListener('submit', e => {
        e.preventDefault(); // Предотвращаем стандартную отправку формы

        // Получаем поле ввода названия цикла
        const nameInput = e.target.querySelector('input[type="text"]');
        if (!nameInput) {
            console.error('Поле ввода названия цикла не найдено');
            return;
        }

        const nameLoop = nameInput.value.trim();

        // Валидация: проверяем, что поле не пустое
        if (nameLoop === '') {
            showError('Название цикла не может быть пустым');
            return;
        }

        // Нормализуем для сравнения: приводим к верхнему регистру и убираем пробелы
        const normalizedName = nameLoop.toUpperCase();
        const existingOptions = Array.from(inputCycle.options)
            .map(option => option.text.trim().toUpperCase());

        // Проверяем, существует ли уже такой цикл
        if (existingOptions.includes(normalizedName)) {
            showError('У вас уже есть цикл с таким названием!');
            nameInput.value = ''; // Очищаем поле
            return;
        }

        // Добавляем новый цикл
        const newOption = new Option(nameLoop, nameLoop); // Используем осмысленное значение
        inputCycle.add(newOption);

        // Показываем успех
        //showSuccess('Цикл успешно добавлен!');

        // Закрываем модальное окно, если кнопка существует
        const closeButton = document.getElementById('close-modal-loop');
        if (closeButton) {
            closeButton.click();
        } else {
            console.warn('Кнопка закрытия модального окна не найдена');
        }

        // Очищаем поле ввода
        nameInput.value = '';
    });

    // Вспомогательные функции для отображения сообщений
    function showError(message) {
        const errorElement = document.getElementById('textError');
        if (errorElement) {
            errorElement.textContent = message; // Безопасное присвоение текста
            errorElement.style.display = 'block';
            openModal.click(); // Показываем модальное окно с ошибкой
        }
    }

    function showSuccess(message) {
        alert(message); // Простое уведомление об успехе
        // Альтернатива: можно добавить элемент с сообщением об успехе на страницу
    }



    nameBook.addEventListener('focus', () => {
        nameBook.classList.remove("error-border");
    });
    inputCategory.addEventListener('focus', () => {
        inputCategory.classList.remove("error-border");
    });
    tegBookInput.addEventListener('focus', () => {
        tegBookInput.classList.remove("error-border");
    });
    inputDescription.addEventListener('focus', () => {
        inputDescription.classList.remove("error-border");
    });

    formNewBook.addEventListener('submit', event => {
        let text = '';

        if (nameBook.value.trim() === "") {
            text += "<div>Поле 'Название книги' не может быть пустым.</div>";
            nameBook.classList.add("error-border");
        } else nameBook.classList.remove("error-border");

        if (!inputCategory.value) {
            text += "<div>Выберите жанр книги.</div>";
            inputCategory.classList.add("error-border");
        } else inputCategory.classList.remove("error-border");

        if (tegBookInput.value.trim() === "") {
            text += "<div>Должен быть хотя бы 1 тег.</div>";
            tegBookInput.classList.add("error-border");
        } else tegBookInput.classList.remove("error-border");

        if (inputDescription.value.trim() === "") {
            text += "<div>Краткое описание не должно быть пустым.</div>";
            inputDescription.classList.add("error-border");
        } else if (inputDescription.value.length < 100) {
            text += "<div>Краткое описание должно быть не менее 100 символов.</div>";
            inputDescription.classList.add("error-border");
        } else inputDescription.classList.remove("error-border");


        if (text !== '') {
            document.getElementById('textError').innerHTML = text;
            openModal.click();
            event.preventDefault();
        }
    });

    inputDescription.addEventListener("input", () => {
        // Обрезаем до 400 символов *до* подсчёта
        inputDescription.value = inputDescription.value.slice(0, 400);
        const textLength = inputDescription.value.length;
        descriptionCharacterCount.textContent = 'Введено ' + textLength + ' символов.';
    });

    tegBookInput.addEventListener("input", () => {
        // Разделяем строку по пробелам и фильтруем пустые элементы
        const tags = tegBookInput.value.trim().split(/\s+/).filter(tag => tag.length > 0);
        const tagCount = tags.length;

        switch (tagCount) {
            case 1:
                TageCharacterCount.textContent = 'Введён ' + tagCount + ' тег.';
                break;
            case 2:
            case 3:
            case 4:
                TageCharacterCount.textContent = 'Введено ' + tagCount + ' тега.';
                break;
            default:
                TageCharacterCount.textContent = 'Введено ' + tagCount + ' тегов.';
        }

        // Ограничиваем количество тегов до 5
        if (tagCount > 5) {
            // Собираем первые 5 тегов и обновляем значение поля
            tegBookInput.value = tags.slice(0, 5).join(' ');
            TageCharacterCount.textContent = 'Введено 5 тегов (максимум).';
        }
    });

    function res() {
        image.src = '';
        TageCharacterCount.textContent = 'Введено 0 тегов.';
        descriptionCharacterCount.textContent = 'Введено 0 символов.';
        nameBook.classList.remove("error-border");
        inputCategory.classList.remove("error-border");
        tegBookInput.classList.remove("error-border");
        inputDescription.classList.remove("error-border");
    }

    fileInput.onchange = (e) => {
        if (!fileInput.files || !fileInput.files[0]) {
            return;
        }

        const file = fileInput.files[0];

        // Проверка типа файла
        if (!file.type.startsWith('image/')) {
            document.getElementById('textError').textContent = 'Пожалуйста, выберите изображение (PNG или JPEG)';
            openModal.click();
            fileInput.value = '';
            return;
        }

        // Проверка размера файла (максимум 5 МБ)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
            document.getElementById('textError').textContent = 'Файл слишком большой. Максимальный размер — 5 МБ.';
            openModal.click();
            fileInput.value = '';
            return;
        }

        const objectURL = URL.createObjectURL(file);
        const img = new Image();

        img.onload = () => {
            const targetWidth = 200;
            const targetHeight = 280;
            const tolerance = 0.10;

            const minWidth = targetWidth * (1 - tolerance);
            const maxWidth = targetWidth * (1 + tolerance);
            const minHeight = targetHeight * (1 - tolerance);
            const maxHeight = targetHeight * (1 + tolerance);

            const actualWidth = img.naturalWidth;
            const actualHeight = img.naturalHeight;

            if (
                actualWidth < minWidth ||
                actualWidth > maxWidth ||
                actualHeight < minHeight ||
                actualHeight > maxHeight
            ) {
                document.getElementById('textError').textContent =
                    'Размеры изображения должны быть близки к 200×280 px (±10 %).';
                openModal.click();
                URL.revokeObjectURL(objectURL);
                fileInput.value = '';
                return;
            }

            image.src = objectURL;
            image.style.display = 'block';
            image.onload = () => URL.revokeObjectURL(objectURL);
        };

        img.onerror = () => {
            alert('Не удалось загрузить изображение. Проверьте файл.');
            URL.revokeObjectURL(objectURL);
            fileInput.value = '';
        };

        img.src = objectURL;
    };
</script>
</body>
</html>