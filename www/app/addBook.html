<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Книга [Добавить книгу]</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="js/close-modal-entry.js" defer></script>
</head>
<body>
<div class="page">
    <header class="header">
        <nav>
            <div>
                <a href="index.html" class="linkImage" title="На главную страницу"><img src="img/logo_mini.jpeg"/></a>
                <a href="rider.html">Читалка</a>
                <div class="dropdown">
                    <button class="dropbtn">Выпадающее</button>
                    <div class="dropdown-content">
                        <a href="str2.html">Книга подробно</a>
                        <a href="myLibrary.html">Моя библиотека</a>
                        <a href="addBook.html">Добавит свою книгу</a>
                        <a href="addChapter.html">Добавит глову в свою книгу</a>
                        <a href="editChapter.html">Редактировать главу</a>
                        <a href="personalAccount.html">Личный кабинет читателя</a>
                        <a href="personalAccountWriter.html">Личный кабинеит писателя</a>
                        <a href="writerPage.html">страница писателя</a>
                    </div>
                </div>
                <div class="control-unit">
                    <div class="search">
                        <input type="text" placeholder="поиск по автору или книге">
                        <button>Поиск</button>
                    </div>
                    <a href="#" title="Начитающие авторы">Новички</a>
                    <a href="#" title="Популярные авторы">Мэтры</a>
                </div>
            </div>
            <div>
                <a href="reg.html">регистрация</a>
                <a href="#modal-entry">вход</a>
            </div>
        </nav>
        <!-- Модальное окно авторизации -->
        <div class="css-modal-target" id="modal-entry">
            <div class="cmt">
                <a href="#close" class="css-modal-close" id="close-modal-entry" title="Закрыть">&times;</a>
                <form>
                    <div class="formEmpty">
                        <h3>ВХОД</h3>
                        <input type="text" id="login" placeholder="логин">
                        <input type="password" placeholder="Пароль" required>
                        <a href="forgetPassword.html">Забыли пароль</a>
                        <button type="submit">Вход</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Конец Модальное окна -->
    </header>
    <main class="main">
        <!-- Модальное окно ошибок -->
        <div class="css-modal-target" id="modal-error">
            <div class="cmt" id="windowBody">
                <a href="#close" class="css-modal-close" id="close-modal-error" title="Закрыть">&times;</a>
                <div class="heading-error">
                    ОШИБКА
                </div>
                <div id="textError"></div>

            </div>
        </div>
        <!-- Конец Модальное окна -->


        <div class="add-book">
            <form id="formNewBook">
                <div class="cart-book">
                    <div class="add-img">
                        <a id="openModal" href="#modal-error">модал</a>
                        <div class="preview">
                            <b>Обложка книги</b><br>
                            Размер изображения должен быть не менее 200 пикселей в ширину и 285 в высоту.<br>
                            Максимальный размер файла: 5 мб.
                        </div>
                        <label for="riss">
                            <div class="block-img">
                                <img id="e4r45t" src="">
                                <input id="riss" type="file" accept="image/png, image/jpeg"/>
                            </div>
                        </label>
                        <label for="riss" class="pseudo-button">загрузить обложку</label>
                    </div>

                    <div class="block-input">
                        <div>
                            <label for="nameBook">Название книги:</label>
                            <input type="text" id="nameBook">
                        </div>

                        <div>
                            <label for="inputCategory">Жанр:</label>
                            <select id="inputCategory">
                                <option value="" selected disabled hidden>Выберите значение</option>
                                <option value="1">Детектив</option>
                                <option value="1">Фантастика</option>
                            </select>
                        </div>
                        <div>
                            <label for="tegBook">
                                Тэги для поиска через пробел. <code>Максимум 5 тегов.</code>
                            </label><br>
                            <label for="tegBook" id="TageCharacterCount">Введено 0 тегов.</label>
                            <textarea id="tegBook" rows="2"></textarea>
                        </div>

                        <div>
                            <label for="inputDescription">
                                Краткое описание книги. Расскажите о чем она. <code>Максимум 400 символов.</code>
                            </label><br>
                            <label for="inputDescription" id="descriptionCharacterCount">Введено 0 символов.</label>
                            <textarea maxlength="400" id="inputDescription" rows="5"></textarea>
                        </div>

                        <div>
                            <label for="inputCycle">Книга входит в цикл:</label>
                            <select id="inputCycle">
                                <option value="" selected disabled hidden>Выберите значение</option>
                                <option value="1">Цикл 1</option>
                                <option value="1">Цикл 2</option>
                                <option value="1">Цикл 3</option>
                            </select>
                        </div>
                        <div>
                            <button type="reset" onclick="res()">Очистить</button>
                            <button type="submit">Сохранить</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </main>
    <footer class="footer">Нижний блок</footer>
</div>
<script>
    const image = document.getElementById("e4r45t");
    const fileInput = document.getElementById("riss");
    const openModal = document.getElementById('openModal');
    const tegBookInput = document.getElementById('tegBook'); // Переименовано для ясности
    const TageCharacterCount = document.getElementById('TageCharacterCount');
    const inputDescription = document.getElementById('inputDescription');
    const descriptionCharacterCount = document.getElementById('descriptionCharacterCount');
    const formNewBook = document.getElementById('formNewBook');

    formNewBook.addEventListener('submit', event => {
        const nameBook = document.getElementById('nameBook');
        const inputCategory = document.getElementById('inputCategory').value;
        const tegBookValue = tegBookInput.value; // Используем переименованную переменную
        const inputDescriptionValue = inputDescription.value;
        const fileInputIs = fileInput.value;

        let text = '';

        if (nameBook.value.trim() === "") {
            text += "<div>Поле 'Название книги' не может быть пустым.</div>";
            nameBook.classList.add("error-border");
        } else nameBook.classList.remove("error-border");

        if (!inputCategory) {
            text += "<div>Выберите жанр книги.</div>";
            document.getElementById("inputCategory").style.border = "2px solid red";
        }
        if (tegBookValue.trim() === "") {
            text += "<div>Должен быть хотя бы 1 тег.</div>";
        }

        // Исправлена логика: ошибка, если длина < 100
        if (inputDescriptionValue.trim() === "") {
            text += "<div>Краткое описание не должно быть пустым.</div>";
        } else if (inputDescriptionValue.length < 100) {
            text += "<div>Краткое описание должно быть не менее 100 символов.</div>";
        }

        console.log(fileInputIs);

        if (text !== '') {
            alert(text);
            event.preventDefault();
        }
    });

    inputDescription.addEventListener("input", () => {
        // Обрезаем до 400 символов *до* подсчёта
        inputDescription.value = inputDescription.value.slice(0, 400);
        const textLength = inputDescription.value.length;
        descriptionCharacterCount.textContent = 'Введено ' + textLength + ' символов.';
    });

    tegBookInput.addEventListener("input", () => {
        // Разделяем строку по пробелам и фильтруем пустые элементы
        const tags = tegBookInput.value.trim().split(/\s+/).filter(tag => tag.length > 0);
        const tagCount = tags.length;

        switch (tagCount) {
            case 1:
                TageCharacterCount.textContent = 'Введён ' + tagCount + ' тег.';
                break;
            case 2:
            case 3:
            case 4:
                TageCharacterCount.textContent = 'Введено ' + tagCount + ' тега.';
                break;
            default:
                TageCharacterCount.textContent = 'Введено ' + tagCount + ' тегов.';
        }

        // Ограничиваем количество тегов до 5
        if (tagCount > 5) {
            // Собираем первые 5 тегов и обновляем значение поля
            tegBookInput.value = tags.slice(0, 5).join(' ');
            TageCharacterCount.textContent = 'Введено 5 тегов (максимум).';
        }
    });

    function res() {
        image.src = '';
        TageCharacterCount.textContent = 'Введено 0 тегов.';
        descriptionCharacterCount.textContent = 'Введено 0 символов.';
    }

    fileInput.onchange = (e) => {
        if (!fileInput.files || !fileInput.files[0]) {
            return;
        }

        const file = fileInput.files[0];

        // Проверка типа файла
        if (!file.type.startsWith('image/')) {
            document.getElementById('textError').textContent = 'Пожалуйста, выберите изображение (PNG или JPEG)';
            openModal.click();
            fileInput.value = '';
            return;
        }

        // Проверка размера файла (максимум 5 МБ)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
            document.getElementById('textError').textContent = 'Файл слишком большой. Максимальный размер — 5 МБ.';
            openModal.click();
            fileInput.value = '';
            return;
        }

        const objectURL = URL.createObjectURL(file);
        const img = new Image();

        img.onload = () => {
            const targetWidth = 200;
            const targetHeight = 280;
            const tolerance = 0.10;

            const minWidth = targetWidth * (1 - tolerance);
            const maxWidth = targetWidth * (1 + tolerance);
            const minHeight = targetHeight * (1 - tolerance);
            const maxHeight = targetHeight * (1 + tolerance);

            const actualWidth = img.naturalWidth;
            const actualHeight = img.naturalHeight;

            if (
                actualWidth < minWidth ||
                actualWidth > maxWidth ||
                actualHeight < minHeight ||
                actualHeight > maxHeight
            ) {
                document.getElementById('textError').textContent =
                    'Размеры изображения должны быть близки к 200×280 px (±10 %).';
                openModal.click();
                URL.revokeObjectURL(objectURL);
                fileInput.value = '';
                return;
            }

            image.src = objectURL;
            image.style.display = 'block';
            image.onload = () => URL.revokeObjectURL(objectURL);
        };

        img.onerror = () => {
            alert('Не удалось загрузить изображение. Проверьте файл.');
            URL.revokeObjectURL(objectURL);
            fileInput.value = '';
        };

        img.src = objectURL;
    };
</script>
</body>
</html>